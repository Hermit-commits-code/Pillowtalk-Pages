name: Deploy Spicy-Reads Cloud Functions

on:
  workflow_dispatch:
    inputs:
      play_service_account_email:
        description: '(optional) Play Console publisher service account email (e.g. service-xxxxx@gcp-sa-playdeveloper.iam.gserviceaccount.com)'
        required: false

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy functions & infra
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: 511866750127

      # NOTE: For safety and least-privilege we skip enabling APIs and IAM bindings in CI.
      # Please enable the required APIs and create the Pub/Sub topic + IAM bindings manually
      # using the Console (instructions in .github/GCP_ACTIONS_README.md). This keeps the
      # CI service account minimal and avoids serviceusage permission issues.

      - name: Ensure Pub/Sub topic exists (skipped in CI)
        run: |
          echo "Skipping topic creation in CI â€” please create 'play-rtdn-topic' manually in Cloud Console if it does not exist."

      - name: Deploy verifyPurchase (HTTP)
        run: |
          gcloud functions deploy verifyPurchase \
            --region=us-central1 \
            --runtime=nodejs18 \
            --entry-point=verifyPurchase \
            --trigger-http \
            --source=functions \
            --service-account=play-api-verifier@511866750127.iam.gserviceaccount.com \
            --set-env-vars=SECRET_NAME=PLAY_API_KEY_JSON,PROJECT_ID=511866750127 \
            --allow-unauthenticated || true

      - name: Deploy handleRtdn (Pub/Sub)
        run: |
          gcloud functions deploy handleRtdn \
            --region=us-central1 \
            --runtime=nodejs18 \
            --entry-point=handleRtdn \
            --trigger-topic=play-rtdn-topic \
            --source=functions \
            --service-account=play-api-verifier@511866750127.iam.gserviceaccount.com \
            --set-env-vars=SECRET_NAME=PLAY_API_KEY_JSON,PROJECT_ID=511866750127 || true

      - name: Output function URLs
        run: |
          echo "verifyPurchase URL:" $(gcloud functions describe verifyPurchase --region=us-central1 --format='value(httpsTrigger.url)' || true)
          echo "handleRtdn trigger topic: play-rtdn-topic"
