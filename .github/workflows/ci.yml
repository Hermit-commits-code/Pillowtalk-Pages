name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  # Set to 'true' to enable Firestore emulator integration job. Kept false by default to avoid extra CI latency.
  RUN_FIREBASE_EMULATOR: 'false'

jobs:
  analyze-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.9.2'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Check generated tropes
        run: dart run tool/generate_tropes.dart --check --input docs/tropes.md --output lib/constants/tropes_categorized.dart

      - name: Run analyzer
        run: flutter analyze

      - name: Run tests
        # Disable analytics during CI runs to avoid sending events from CI workers.
        run: flutter test --coverage --dart-define=DISABLE_ANALYTICS=true

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: coverage/lcov.info

  # Optional job: run the Firestore emulator and execute tests against it.
  # Disabled by default; enable by setting RUN_FIREBASE_EMULATOR=true in workflow_dispatch or repository env.
  emulator-tests:
    if: env.RUN_FIREBASE_EMULATOR == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Start Firestore emulator
        # Start the emulator in the background and wait for the port to be available.
        run: |
          firebase emulators:start --only firestore --project=demo-project --host=127.0.0.1 --port=8080 &
          npx wait-on tcp:127.0.0.1:8080

      - name: Expose FIRESTORE_EMULATOR_HOST
        run: echo "FIRESTORE_EMULATOR_HOST=127.0.0.1:8080" >> $GITHUB_ENV

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.9.2'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests against emulator (analytics disabled)
        run: flutter test --dart-define=DISABLE_ANALYTICS=true
