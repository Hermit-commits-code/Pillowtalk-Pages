# Pillowtalk: migrate_series_normalized tool

This tool helps migrate existing `books` documents to set `seriesName_normalized` and also provides a small bulk-import helper.

Location: `tools/migrate_series_normalized`

Prerequisites

- Node 16+
- A Firebase service account JSON with Firestore write permissions OR set `GOOGLE_APPLICATION_CREDENTIALS` to point to a service account file.

Install

```bash
cd tools/migrate_series_normalized
npm install
```

Quick dry-run migration (scan and report changes, no writes):

```bash
node index.js --mode=migrate --dryRun --limit=50
```

Actual migration (commits changes):

```bash
node index.js --mode=migrate --limit=1000
```

Import books from CSV or JSON

CSV must have a header row. Supported columns: `title`, `author`, `isbn`, `seriesName`, `seriesIndex`, `genre`, etc.

```bash
# dry-run
node index.js --mode=import --input=books.csv --dryRun --limit=50

# real run
node index.js --mode=import --input=books.csv
```

- If an ISBN value is present in the `isbn` column it will be used as the document ID by default.
- If not present, the tool creates a stable slug from `title + author` and uses that as the ID. You can override with `--idField` to use another field as ID.

Normalization

- `seriesName_normalized` is generated by lowercasing, removing diacritics (accents), removing punctuation, collapsing whitespace, and trimming. This improves fuzzy/prefix search matching across accented and punctuation-variant titles.

Document IDs

- If an ISBN value is present in the `isbn` column it will be used as the document ID by default.
- If not present, the tool creates a stable slug from `title + author` and uses that as the ID. You can override with `--idField` to use another field as ID.

Options

- `--serviceAccount` - Path to service account JSON (optional if `GOOGLE_APPLICATION_CREDENTIALS` is set).
- `--mode` - `migrate` or `import` (default: `migrate`).
- `--collection` - Firestore collection to operate on (default: `books`).
- `--dryRun` - Do not write changes.
- `--limit` - Limit how many records to process (useful for testing).
- `--batchSize` - Batch size for batched writes (default: 500, max 500).
- `--force` - Force overwrites when importing or migrating.
- `--idField` - Field to use as document ID in import mode.

- `--aggregatesCollection` - Collection to write aggregates to (default: `book_aggregates`).
- `--mergeToBooksIfExists` - If set, also merge aggregates into existing `books/{bookId}` docs (no placeholders).

Reconciliation mode

- `--mode=reconcile` scans `users/*/ratings` and `users/*/library` to recompute per-book aggregates (avgSpice and ratingCount). Use `--dryRun` to preview the changes. When run (not dry-run) the tool writes `reconcile_changed_<ts>.json` and a CSV for audit.

CSV audit

- The tool writes both JSON and CSV audit logs for migrate and reconcile runs when not in `--dryRun` mode. Files are written under `tools/migrate_series_normalized/`.

Safety notes

- Run with `--dryRun` and small `--limit` first.
- Keep batch size <= 500.
- Do not check-in service account JSON. Use CI secrets for automation.

Audit log

- When running a real migration (not `--dryRun`) the tool will write a JSON file under `tools/migrate_series_normalized/` listing changed document IDs and their new `seriesName_normalized` values. Keep this file for audit and potential rollback.

CI / GitHub Actions

- You can add a workflow that runs this script using a repo secret `SERVICE_ACCOUNT_JSON` (base64-encoded) and writes it to a file at runtime.

Example GitHub Actions snippet is provided in `.github/workflows/migrate_series.yml`.
