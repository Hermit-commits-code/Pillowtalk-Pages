rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.admin == true ||
        request.auth.token.get('admin', false) == true
      );
    }

    // Pre-seeded books collection - make metadata publicly readable.
    // Books are considered catalog metadata and can be read by any client.
    match /books/{bookId} {
      // Public read for book metadata. If you want to restrict access to
      // book documents, change this condition accordingly.
      allow read: if true;
      allow create, update, delete: if false; // Prevent client-side modifications
    }

    // Curated collections - visibility-based read rules.
    // Each collection document may include a `visibility` field with values
    // like 'public' or 'pro'. Public collections are readable by everyone.
    // Pro collections require the calling user to have a custom `pro` claim.
    match /collections/{collectionId} {
      allow read: if resource.data.visibility == 'public' ||
                  (request.auth != null && request.auth.token.pro == true);
      allow create, update, delete: if false; // Admin-only (via backend)
    }

    // Per-user documents (profile) and nested collections
    match /users/{userId} {
      // Allow only the user to create/read/update/delete their own top-level user doc
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;

      // User's personal library (nested collection) - only the user can read/write
      // Allows updating fields like 'ownership', 'genres', 'tropes', 'warnings', etc.
      match /library/{bookId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // User's personal lists (shelves) - only the user can read/write
      match /lists/{listId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Social / Friends collection - per-user friendships
    match /users/{userId}/friends/{friendId} {
      // Allow users to read/write their own friends list
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Affiliate clicks tracking - authenticated write, read for owner or admin
    match /affiliate_clicks/{clickId} {
      // Allow authenticated users to log their own affiliate clicks
      allow create: if request.auth != null;
      // Allow users to read their own clicks, or admins can read all
      allow read: if request.auth != null && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow update, delete: if false; // Read-only collection for audit purposes
    }

    // App config - admin-only writes, authenticated reads
    match /app_config/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
