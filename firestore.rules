rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Pre-seeded books collection - read-only for authenticated users
    match /books/{bookId} {
      allow read: if request.auth != null;
      allow create, update, delete: if false; // Prevent client-side modifications
    }

    // Curated collections - read-only for authenticated users
    match /collections/{collectionId} {
      allow read: if request.auth != null;
      allow create, update, delete: if false; // Admin-only (via backend)
    }

    // Per-user documents (profile) and nested collections
    match /users/{userId} {
      // Allow only the user to create/read/update/delete their own top-level user doc
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;

      // User's personal library (nested collection) - only the user can read/write
      // Allows updating fields like 'ownership', 'genres', 'tropes', 'warnings', etc.
      match /library/{bookId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // User's personal lists (shelves) - only the user can read/write
      match /lists/{listId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
